<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title id="page-title">EcoImpact AI - Assessment</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* All CSS from the previous correct version */
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,100..1000&display=swap');
        body { --c-glass: #bbbbbc; --c-light: #fff; --c-dark: #000; --c-content: #224; --c-action: #0052f5; --c-bg: #E8E8E9; --glass-reflex-dark: 1; --glass-reflex-light: 1; --saturation: 150%; font-size: 20px; font-family: "DM Sans", sans-serif; font-optical-sizing: auto; background: var(--c-bg); color: var(--c-content); transition: background 400ms cubic-bezier(1, 0.0, 0.4, 1), color 400ms cubic-bezier(1, 0.0, 0.4, 1); }
        body:has(input[value="dark"]:checked) { --c-content: #e1e1e1; --c-action: #03d5ff; --c-bg: #1b1b1d; --glass-reflex-dark: 2; --glass-reflex-light: 0.3; --saturation: 150%; }
        body:has(input[value="dim"]:checked) { --c-light: #99deff; --c-dark: #20001b; --c-glass: hsl(335 250% 74% / 1); --c-content: #d5dbe2; --c-action: #ff48a9; --c-bg: #152433; --glass-reflex-dark: 2; --glass-reflex-light: 0.7; --saturation: 200%; }
        .switcher { position: fixed; z-index: 1000; top: 40px; left: 50%; translate: -50%; display: flex; align-items: center; gap: 8px; width: 244px; height: 70px; box-sizing: border-box; padding: 8px 12px 10px; margin: 0 auto; border: none; border-radius: 99em; background-color: color-mix(in srgb, var(--c-glass) 12%, transparent); backdrop-filter: blur(8px) url(#switcher-blur) saturate(var(--saturation)); -webkit-backdrop-filter: blur(8px) saturate(var(--saturation)); box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent), inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent); transition: background-color 400ms cubic-bezier(1, 0.0, 0.4, 1), box-shadow 400ms cubic-bezier(1, 0.0, 0.4, 1); }
        .switcher__legend, .switcher__input { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0 0 0 0); white-space: nowrap; border-width: 0; }
        .switcher__icon { display: block; width: 100%; transition: scale 200ms cubic-bezier(0.5, 0, 0, 1); }
        .switcher__filter { position: absolute; width: 0; height: 0; z-index: -1; }
        .switcher__option { --c: var(--c-content); display: flex; justify-content: center; align-items: center; padding: 0 16px; width: 68px; height: 100%; box-sizing: border-box; border-radius: 99em; opacity: 1; transition: all 160ms; }
        .switcher__option:hover { --c: var(--c-action); cursor: pointer; } .switcher__option:hover .switcher__icon { scale: 1.2; }
        .switcher__option:has(input:checked) { --c: var(--c-content); cursor: auto; } .switcher__option:has(input:checked) .switcher__icon { scale: 1; }
        .switcher::after { content: ''; position: absolute; left: 4px; top: 4px; display: block; width: 84px; height: calc(100% - 10px); border-radius: 99em; background-color: color-mix(in srgb, var(--c-glass) 36%, transparent); z-index: -1; box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent), inset 2px 1px 0px -1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), inset -1.5px -1px 0px -1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), inset -2px -6px 1px -5px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), inset -1px 2px 3px -1px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), inset 0px -4px 1px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 0px 3px 6px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent); }
        .switcher:has(input[c-option="1"]:checked)::after { translate: 0 0; transform-origin: right; transition: background-color 400ms cubic-bezier(1, 0.0, 0.4, 1), box-shadow 400ms cubic-bezier(1, 0.0, 0.4, 1), translate 400ms cubic-bezier(1, 0.0, 0.4, 1); animation: scaleToggle 440ms ease; }
        .switcher:has(input[c-option="2"]:checked)::after { translate: 76px 0; transition: background-color 400ms cubic-bezier(1, 0.0, 0.4, 1), box-shadow 400ms cubic-bezier(1, 0.0, 0.4, 1), translate 400ms cubic-bezier(1, 0.0, 0.4, 1); animation: scaleToggle2 440ms ease; }
        .switcher[c-previous="1"]:has(input[c-option="2"]:checked)::after { transform-origin: left; } .switcher[c-previous="3"]:has(input[c-option="2"]:checked)::after { transform-origin: right; }
        .switcher:has(input[c-option="3"]:checked)::after { translate: 152px 0; transform-origin: left; transition: background-color 400ms cubic-bezier(1, 0.0, 0.4, 1), box-shadow 400ms cubic-bezier(1, 0.0, 0.4, 1), translate 400ms cubic-bezier(1, 0.0, 0.4, 1); animation: scaleToggle3 440ms ease; }
        @keyframes scaleToggle { 0% { scale: 1 1; } 50% { scale: 1.1 1; } 100% { scale: 1 1; } } @keyframes scaleToggle2 { 0% { scale: 1 1; } 50% { scale: 1.2 1; } 100% { scale: 1 1; } } @keyframes scaleToggle3 { 0% { scale: 1 1; } 50% { scale: 1.1 1; } 100% { scale: 1 1; } }
        body { overflow-x: hidden; min-height: 100vh; padding: 2rem; margin: 0; }
        h1, h2 { color: var(--c-content); margin: 1.4em 0 0.6em; width: 100%; max-width: 600px; box-sizing: border-box; border-bottom: 2px solid color-mix(in srgb, var(--c-content) 50%, transparent); padding-bottom: 0.625rem; }
        h1 { font-size: 3em; } h2 { font-size: 2em; }
        :root { --font-size-min: 16; --font-size-max: 20; --font-ratio-min: 1.2; --font-ratio-max: 1.33; --font-width-min: 375; --font-width-max: 1500; --content-width: 720px; }
        :where(.fluid) { --fluid-min: calc( var(--font-size-min) * pow(var(--font-ratio-min), var(--font-level, 0)) ); --fluid-max: calc( var(--font-size-max) * pow(var(--font-ratio-max), var(--font-level, 0)) ); --fluid-preferred: calc( (var(--fluid-max) - var(--fluid-min)) / (var(--font-width-max) - var(--font-width-min)) ); --fluid-type: clamp( (var(--fluid-min) / 16) * 1rem, ((var(--fluid-min) / 16) * 1rem) - (((var(--fluid-preferred) * var(--font-width-min)) / 16) * 1rem) + (var(--fluid-preferred) * var(--variable-unit, 100vi)), (var(--fluid-max) / 16) * 1rem ); font-size: var(--fluid-type); }
        *, *:after, *:before { box-sizing: border-box; }
        body::before { --size: 45px; --line: color-mix(in hsl, var(--c-content), transparent 80%); content: ''; height: 100vh; width: 100vw; position: fixed; background: linear-gradient( 90deg, var(--line) 1px, transparent 1px var(--size) ) calc(var(--size) * 0.36) 50% / var(--size) var(--size), linear-gradient(var(--line) 1px, transparent 1px var(--size)) 0% calc(var(--size) * 0.32) / var(--size) var(--size); mask: linear-gradient(-20deg, transparent 50%, var(--c-light)); top: 0; transform-style: flat; pointer-events: none; z-index: -1; }
        .container { width: var(--content-width); max-width: calc(100vw - 4rem); margin: 120px auto 12rem; }
        .glass-card { background: color-mix(in srgb, var(--c-glass) 12%, transparent); backdrop-filter: saturate(var(--saturation)) blur(10px); border-radius: 12px; padding: 2rem; box-shadow: 0 0 2px 1px color-mix(in srgb, var(--c-dark) 50%, transparent) inset, 0 0 10px 4px color-mix(in srgb, var(--c-dark) 30%, transparent) inset, 0px 4px 16px color-mix(in srgb, var(--c-dark) 5%, transparent), 0px 8px 24px color-mix(in srgb, var(--c-dark) 5%, transparent), 0px 16px 56px color-mix(in srgb, var(--c-dark) 5%, transparent); animation: fadeIn 0.5s ease-out; color: var(--c-content); border: 1px solid color-mix(in srgb, var(--c-light) 50%, transparent); }
        .form-group { margin-bottom: 1.25rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--c-content); }
        input[type="number"], input[type="text"], select { width: 100%; padding: 0.75rem; box-sizing: border-box; border: 1px solid color-mix(in srgb, var(--c-content) 50%, transparent); border-radius: 0.625rem; background: color-mix(in srgb, var(--c-bg) 50%, transparent); color: var(--c-content); font-size: 1rem; transition: background 0.3s, border-color 0.3s; }
        input[type="number"]:focus, input[type="text"]:focus, select:focus { outline: none; background: color-mix(in srgb, var(--c-bg) 70%, transparent); border-color: var(--c-action); }
        input.invalid { border-color: #ff6b6b; }
        input[type="number"]::placeholder, input[type="text"]::placeholder { color: color-mix(in srgb, var(--c-content) 50%, transparent); }
        button { padding: 0.75rem 1.56rem; background: var(--c-action); color: var(--c-light); border: none; border-radius: 0.625rem; cursor: pointer; font-size: 1rem; font-weight: bold; margin-right: 0.94rem; transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s; box-shadow: 0 4px 15px color-mix(in srgb, var(--c-dark) 50%, transparent); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px color-mix(in srgb, var(--c-dark) 70%, transparent); }
        button:disabled { background: color-mix(in srgb, var(--c-content) 50%, transparent); cursor: not-allowed; transform: none; box-shadow: none; }
        .log-button, .search-button, .pdf-button { background: color-mix(in srgb, var(--c-action) 70%, var(--c-bg)); color: var(--c-content); }
        .error { color: #ff6b6b; background: color-mix(in srgb, #ff6b6b, var(--c-bg) 80%); padding: 0.94rem; border-radius: 0.625rem; margin-top: 1.25rem; border: 1px solid color-mix(in srgb, #ff6b6b, var(--c-bg) 70%); animation: fadeIn 0.5s ease-out; }
        .result { margin-top: 1.56rem; padding: 1.25rem; background: color-mix(in srgb, #2ecc71, var(--c-bg) 80%); border: 1px solid color-mix(in srgb, #2ecc71, var(--c-bg) 70%); border-radius: 0.94rem; animation: fadeIn 0.5s ease-out; color: var(--c-content); }
        .result h3 { margin-top: 0; color: var(--c-content); } .result pre { color: var(--c-content); background: color-mix(in srgb, var(--c-bg) 90%, transparent); padding: 0.94rem; border-radius: 0.625rem; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .dock-icon { width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s ease-out; text-decoration: none; }
        .dock-icon:hover { transform: scale(1.2); }
        .dock-icon img { width: 100%; height: 100%; object-fit: contain; border-radius: 8px; }
        .dock-separator { width: 1px; height: 40px; background-color: color-mix(in srgb, var(--c-light) 30%, transparent); margin: 0 10px; }
        .lang-icon { font-size: 2.5rem; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .dock { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: center; align-items: center; gap: 15px; padding: 10px; z-index: 1000; background: color-mix(in srgb, var(--c-light) 8%, transparent); -webkit-backdrop-filter: url(#frosted-glass); backdrop-filter: url(#frosted-glass); border: none; border-top: 2px solid color-mix(in srgb, var(--c-light) 60%, transparent); box-shadow: 0 -16px 32px color-mix(in srgb, var(--c-dark) 12%, transparent); }
        .wizard-step { display: none; animation: fadeIn 0.5s ease-out; }
        .wizard-progress { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; }
        .wizard-progress-step { width: 20px; height: 20px; border-radius: 50%; background: color-mix(in srgb, var(--c-action) 20%, transparent); transition: background-color 0.3s, transform 0.3s; }
        .wizard-progress-step.active { background: var(--c-action); transform: scale(1.2); }
        .wizard-progress-step.finish { background: color-mix(in srgb, #2ecc71, var(--c-bg) 10%); }
        .wizard-navigation { margin-top: 2rem; display: flex; justify-content: space-between; align-items: center; }
        .chart-container { position: relative; margin: 2rem auto; height: 40vh; max-height: 450px; width: 100%; }
        /* Custom Map Marker Styles */
        .custom-marker { background: transparent !important; border: none !important; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 12px; }
        
        @media (max-width: 768px) {
            .result > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
            .chart-container { height: 50vh; max-height: 400px; }
            .chart-container h4 { font-size: 1rem !important; }
            .chart-container button { font-size: 0.75rem !important; padding: 0.3rem 0.6rem !important; }
            #siteMap { height: 300px !important; }
        }
    </style>
</head>
<body>
    <form class="switcher" id="theme-switcher">
        <legend class="switcher__legend">Theme Switcher</legend>
        <div class="switcher__option">
            <input type="radio" name="theme" id="light" value="light" checked c-option="1" class="switcher__input" />
            <label for="light" onclick="setPrevious(1)"><svg class="switcher__icon" viewBox="0 0 24 24" fill="var(--c)"><path d="M12 2A10 10 0 0 0 2 12A10 10 0 0 0 12 22A10 10 0 0 0 22 12A10 10 0 0 0 12 2M12 4A8 8 0 0 1 20 12A8 8 0 0 1 12 20A8 8 0 0 1 4 12A8 8 0 0 1 12 4M12 6A6 6 0 0 0 6 12A6 6 0 0 0 12 18A6 6 0 0 0 18 12A6 6 0 0 0 12 6Z" fill="currentColor"/></svg></label>
        </div>
        <div class="switcher__option">
            <input type="radio" name="theme" id="dark" value="dark" c-option="2" class="switcher__input" />
            <label for="dark" onclick="setPrevious(2)"><svg class="switcher__icon" viewBox="0 0 24 24" fill="var(--c)"><path d="M12 2.25A9.75 9.75 0 0 0 2.25 12A9.75 9.75 0 0 0 12 21.75V2.25M12 4V20A8 8 0 0 0 20 12A8 8 0 0 0 12 4Z" fill="currentColor"/></svg></label>
        </div>
        <div class="switcher__option">
            <input type="radio" name="theme" id="dim" value="dim" c-option="3" class="switcher__input" />
            <label for="dim" onclick="setPrevious(3)"><svg class="switcher__icon" viewBox="0 0 24 24" fill="var(--c)"><path d="M12 2L9.19 8.62L2 9.27L7.54 14.1L5.82 21L12 17.27L18.18 21L16.46 14.1L22 9.27L14.81 8.62L12 2Z" fill="currentColor"/></svg></label>
        </div>
        <svg class="switcher__filter" width="0" height="0"><filter id="switcher-blur"><feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur" /></filter></svg>
    </form>
    
    <div class="container">
        <h1 id="main-header" class="fluid" style="--font-level: 3;">EcoImpact AI - Environmental Impact Assessment</h1>
        <div class="glass-card">
            
            <form method="POST" id="main-form">
                <!-- Wizard Progress Bar -->
                <div class="wizard-progress">
                    <span class="wizard-progress-step"></span>
                    <span class="wizard-progress-step"></span>
                    <span class="wizard-progress-step"></span>
                </div>

                <!-- Step 1: Mining Details -->
                <div class="form-section wizard-step">
                    <h2 id="mining-details-header" class="fluid" style="--font-level: 2;">Mining Operation Details</h2>
                    <div class="form-group">
                        <label id="label-location-search-form" for="location_search">Location (Name or Coordinates): <span style="color: #c0392b;">*</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: start;">
                            <input type="text" id="input-location-search-form" name="location_search" required placeholder="e.g., 51.1655¬∞ N, 71.4272¬∞ E or Bingham Canyon Mine" style="flex: 1;">
                            <button type="button" class="search-button" onclick="searchOnGoogleEarth()" style="margin: 0; white-space: nowrap;">üåç Google Earth</button>
                        </div>
                        <small style="color: var(--c-content); opacity: 0.7; font-size: 0.8rem; display: block; margin-top: 0.25rem;">
                            üí° Formats: "51.1655¬∞ N, 71.4272¬∞ E" ‚Ä¢ "40.5236, -112.1520" ‚Ä¢ "Sydney, Australia"
                        </small>
                    </div>
                    <div class="form-group"><label id="label-annual-production" for="annual_production_volume">Annual Production Volume (tons/year):</label><input type="number" step="any" name="annual_production_volume" required placeholder="e.g., 350000"></div>
                    <div class="form-group"><label id="label-mining-depth" for="mining_depth">Mining Depth (meters):</label><input type="number" step="any" name="mining_depth" required placeholder="e.g., 450"></div>
                    <div class="form-group"><label id="label-operation-years" for="operation_years">Operation Years:</label><input type="number" step="any" name="operation_years" required placeholder="e.g., 25"></div>
                    <div class="form-group"><label id="label-mine-type" for="mine_type">Type of Mine:</label><select name="mine_type" required><option value="" disabled selected id="option-select">Select...</option><option value="Open-pit" id="option-open-pit">Open-pit</option><option value="Underground" id="option-underground">Underground</option><option value="Mixed" id="option-mixed">Mixed</option></select></div>
                    <div class="form-group"><label id="label-mineral-type" for="primary_mineral_type">Primary Mineral Type:</label><select name="primary_mineral_type" required><option value="" disabled selected id="option-select-mineral">Select...</option><option value="Coal" id="option-coal">Coal</option><option value="Copper" id="option-copper">Copper</option><option value="Gold" id="option-gold">Gold</option><option value="Uranium" id="option-uranium">Uranium</option><option value="Iron" id="option-iron">Iron</option><option value="Zinc-Lead" id="option-zinc-lead">Zinc-Lead</option><option value="Polymetallic" id="option-polymetallic">Polymetallic</option></select></div>
                </div>

                <!-- Step 2: Geographic Parameters -->
                <div class="form-section wizard-step">
                    <h2 id="geo-params-header" class="fluid" style="--font-level: 2;">Geographic Parameters</h2>
                    <div class="form-group"><label id="label-distance-water" for="distance_to_water_body">Distance to Nearest Water Body (km):</label><input type="number" step="any" name="distance_to_water_body" required placeholder="e.g., 3.2"></div>
                    <div class="form-group"><label id="label-elevation" for="elevation">Elevation (meters above sea level):</label><input type="number" step="any" name="elevation" required placeholder="e.g., 340"></div>
                    <div class="form-group"><label id="label-precipitation" for="annual_precipitation">Annual Precipitation (mm/year):</label><input type="number" step="any" name="annual_precipitation" required placeholder="e.g., 120"></div>
                    <div class="form-group"><label id="label-soil-type" for="soil_type">Soil Type:</label><select name="soil_type" required><option value="" disabled selected id="option-select-soil">Select...</option><option value="Sandy" id="option-sandy">Sandy</option><option value="Clay" id="option-clay">Clay</option><option value="Loam" id="option-loam">Loam</option><option value="Rocky" id="option-rocky">Rocky</option><option value="Mountain" id="option-mountain">Mountain</option><option value="Desert" id="option-desert">Desert</option></select></div>
                </div>

                <!-- Step 3: Environmental Baseline -->
                <div class="form-section wizard-step">
                    <h2 id="env-baseline-header" class="fluid" style="--font-level: 2;">Environmental Baseline</h2>
                    <div class="form-group"><label id="label-water-quality" for="baseline_water_quality">Baseline Water Quality (1-10):</label><input type="number" step="any" name="baseline_water_quality" min="1" max="10" required placeholder="e.g., 6.5"></div>
                    <div class="form-group"><label id="label-air-quality" for="baseline_air_quality">Baseline Air Quality (1-10):</label><input type="number" step="any" name="baseline_air_quality" min="1" max="10" required placeholder="e.g., 7"></div>
                    <div class="form-group"><label id="label-vegetation-ndvi" for="baseline_vegetation_ndvi">Baseline Vegetation NDVI (0-1):</label><input type="number" step="any" name="baseline_vegetation_ndvi" min="0" max="1" required placeholder="e.g., 0.45"></div>
                </div>

                <!-- Wizard Navigation -->
                <div class="wizard-navigation">
                    <div>
                         <a href="{{ url_for('show_logs') }}"><button type="button" class="log-button" id="button-logs">View Logs</button></a>
                    </div>
                    <div>
                        <button type="button" id="prevBtn" onclick="navigateWizard(-1)">Previous</button>
                        <button type="button" id="nextBtn" onclick="navigateWizard(1)">Next</button>
                    </div>
                </div>
            </form>


            {% if error %} <div class="error"><h3 id="error-header">Error:</h3><p>{{ error }}</p></div> {% endif %}
            
            {% if result_data %} 
            <div class="result">
                <h3 id="results-header">Analysis Results:</h3>
                
                <!-- Charts Section -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0;">
                    <div class="chart-container">
                        <h4 style="text-align: center; color: var(--c-content); margin-bottom: 1rem;">Risk Distribution</h4>
                        <canvas id="riskRadarChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4 style="text-align: center; color: var(--c-content); margin-bottom: 1rem;">Category Risk Levels</h4>
                        <canvas id="riskBarChart"></canvas>
                    </div>
                </div>
                
                <!-- Additional Charts Section -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0;">
                    <div class="chart-container" style="height: 35vh;">
                        <h4 style="text-align: center; color: var(--c-content); margin-bottom: 1rem;">Risk Proportion</h4>
                        <canvas id="riskPieChart"></canvas>
                    </div>
                    <div class="chart-container" style="height: 35vh;">
                        <h4 style="text-align: center; color: var(--c-content); margin-bottom: 1rem;">Risk Comparison</h4>
                        <canvas id="riskDoughnutChart"></canvas>
                    </div>
                </div>
                
                <!-- Interactive Map Section -->
                <div style="margin: 2rem 0;">
                    <h4 style="color: var(--c-content); margin-bottom: 1rem;">üìç Mining Site Location</h4>
                    <div id="siteMap" style="height: 400px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
                    <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--c-content); opacity: 0.7;">
                        üó∫Ô∏è Pin color indicates risk level: 
                        <span style="color: #27ae60; font-weight: bold;">‚óè</span> Low 
                        <span style="color: #f39c12; font-weight: bold;">‚óè</span> Moderate 
                        <span style="color: #c0392b; font-weight: bold;">‚óè</span> High
                        <br>
                        üí° <strong>Supported coordinate formats:</strong> "51.1655¬∞ N, 71.4272¬∞ E" ‚Ä¢ "40.5236, -112.1520" ‚Ä¢ "51.1655 N 71.4272 E"
                        <br>
                        üí° <strong>Or use location names:</strong> "Bingham Canyon Mine, Utah" ‚Ä¢ "Sydney, Australia"
                    </p>
                </div>
                
                <!-- Overall Risk Score Display -->
                <div style="background: color-mix(in srgb, var(--c-bg) 70%, transparent); border-radius: 0.625rem; padding: 1.5rem; margin: 1.5rem 0; text-align: center;">
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--c-content); font-size: 1.2rem;">Overall Environmental Risk Score</h4>
                    <div style="font-size: 3rem; font-weight: bold; 
                        {% if result_data.overall_risk_score < 4 %}color: #27ae60;
                        {% elif result_data.overall_risk_score < 7 %}color: #f39c12;
                        {% else %}color: #c0392b;{% endif %}">
                        {{ result_data.overall_risk_score }}/10
                    </div>
                    <div style="font-size: 1rem; margin-top: 0.5rem; font-weight: bold; 
                        {% if result_data.overall_risk_score < 4 %}color: #27ae60;
                        {% elif result_data.overall_risk_score < 7 %}color: #f39c12;
                        {% else %}color: #c0392b;{% endif %}">
                        {% if result_data.overall_risk_score < 4 %}LOW RISK
                        {% elif result_data.overall_risk_score < 7 %}MODERATE RISK
                        {% else %}HIGH RISK{% endif %}
                    </div>
                </div>

                <!-- Executive Summary -->
                <div style="background: color-mix(in srgb, #3498db 10%, var(--c-bg) 90%); border-left: 4px solid #3498db; padding: 1rem; margin: 1.5rem 0; border-radius: 0.625rem;">
                    <h4 style="margin: 0 0 0.75rem 0; color: var(--c-content);">Executive Summary</h4>
                    <p style="margin: 0; line-height: 1.6; color: var(--c-content);">{{ result_data.summary }}</p>
                </div>

                <!-- Detailed Risk Breakdown -->
                <div style="margin: 1.5rem 0;">
                    <h4 style="color: var(--c-content); margin-bottom: 1rem;">Detailed Risk Breakdown</h4>
                    {% for risk in result_data.risks %}
                    <div style="background: color-mix(in srgb, var(--c-bg) 70%, transparent); border-radius: 0.625rem; padding: 1.25rem; margin-bottom: 1rem; border-left: 4px solid 
                        {% if risk.score < 4 %}#27ae60{% elif risk.score < 7 %}#f39c12{% else %}#c0392b{% endif %};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h5 style="margin: 0; color: var(--c-content); font-size: 1.1rem;">{{ risk.category }}</h5>
                            <span style="font-size: 1.5rem; font-weight: bold; 
                                {% if risk.score < 4 %}color: #27ae60;
                                {% elif risk.score < 7 %}color: #f39c12;
                                {% else %}color: #c0392b;{% endif %}">
                                {{ risk.score }}/10
                            </span>
                        </div>
                        <p style="margin: 0; color: var(--c-content); line-height: 1.6;">{{ risk.details }}</p>
                    </div>
                    {% endfor %}
                </div>

                <form action="{{ url_for('generate_report') }}" method="POST" style="margin-top: 1.5rem; text-align: right;">
                    <input type="hidden" name="report_data" value="{{ result_data | tojson | forceescape }}">
                    <button type="submit" class="pdf-button" id="button-pdf">Download PDF Report</button>
                </form>
            </div>

            <script>
                // Make resultData available globally for all chart and map functions
                const resultData = JSON.parse('{{ result_data | tojson | safe }}');
                
                (function() {
                    const labels = resultData.risks.map(risk => risk.category);
                    const scores = resultData.risks.map(risk => risk.score);
                    const details = resultData.risks.map(risk => risk.details);
                    const overallScore = resultData.overall_risk_score;
                    
                    const currentBodyStyles = getComputedStyle(document.body);
                    const gridColor = currentBodyStyles.getPropertyValue('--c-content').trim() + '30';
                    const textColor = currentBodyStyles.getPropertyValue('--c-content').trim();
                    const pointColor = currentBodyStyles.getPropertyValue('--c-action').trim();
                    const fillColor = pointColor + '4D';
                    
                    // Generate dynamic colors based on risk categories and levels
                    const backgroundColors = scores.map((score, index) => {
                        const category = labels[index];
                        // Base colors for different categories
                        if (category.includes('Water')) {
                            return score < 4 ? 'rgba(52, 152, 219, 0.7)' :  // Blue for water - low risk
                                   score < 7 ? 'rgba(52, 152, 219, 0.8)' :  // Blue for water - medium risk
                                   'rgba(231, 76, 60, 0.9)';                // Red for water - high risk
                        }
                        if (category.includes('Air')) {
                            return score < 4 ? 'rgba(46, 204, 113, 0.7)' :  // Green for air - low risk
                                   score < 7 ? 'rgba(241, 196, 15, 0.8)' :  // Yellow for air - medium risk
                                   'rgba(230, 126, 34, 0.9)';               // Orange for air - high risk
                        }
                        if (category.includes('Land') || category.includes('Biodiversity')) {
                            return score < 4 ? 'rgba(39, 174, 96, 0.7)' :   // Green for nature - low risk
                                   score < 7 ? 'rgba(243, 156, 18, 0.8)' :  // Orange for nature - medium risk
                                   'rgba(192, 57, 43, 0.9)';                // Red for nature - high risk
                        }
                        // Default fallback colors
                        if (score < 4) return 'rgba(155, 89, 182, 0.7)';    // Purple - low risk
                        if (score < 7) return 'rgba(142, 68, 173, 0.8)';    // Purple - medium risk
                        return 'rgba(155, 89, 182, 0.9)';                   // Purple - high risk
                    });
                    
                    const borderColors = scores.map((score, index) => {
                        const category = labels[index];
                        // Border colors matching background colors but solid
                        if (category.includes('Water')) {
                            return score < 4 ? 'rgba(52, 152, 219, 1)' :     // Blue for water
                                   score < 7 ? 'rgba(52, 152, 219, 1)' :
                                   'rgba(231, 76, 60, 1)';
                        }
                        if (category.includes('Air')) {
                            return score < 4 ? 'rgba(46, 204, 113, 1)' :     // Green for air
                                   score < 7 ? 'rgba(241, 196, 15, 1)' :
                                   'rgba(230, 126, 34, 1)';
                        }
                        if (category.includes('Land') || category.includes('Biodiversity')) {
                            return score < 4 ? 'rgba(39, 174, 96, 1)' :      // Green for nature
                                   score < 7 ? 'rgba(243, 156, 18, 1)' :
                                   'rgba(192, 57, 43, 1)';
                        }
                        // Default fallback
                        return 'rgba(155, 89, 182, 1)';                      // Purple
                    });
                    
                    // Radar Chart
                    const ctxRadar = document.getElementById('riskRadarChart').getContext('2d');
                    
                    // Create wrapped labels for radar chart
                    const radarLabels = labels.map(label => {
                        if (label.includes('Water')) return ['Water', 'Contamination'];
                        if (label.includes('Air')) return ['Air Quality', 'Degradation'];
                        if (label.includes('Land')) return ['Land &', 'Biodiversity'];
                        return label.split(' ');
                    });
                    
                    new Chart(ctxRadar, {
                        type: 'radar',
                        data: {
                            labels: radarLabels,
                            datasets: [{
                                label: 'Risk Score (0-10)',
                                data: scores,
                                backgroundColor: fillColor,
                                borderColor: pointColor,
                                borderWidth: 3,
                                pointBackgroundColor: borderColors,
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: pointColor,
                                pointRadius: 6,
                                pointHoverRadius: 8,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    angleLines: { color: gridColor },
                                    grid: { color: gridColor },
                                    pointLabels: { 
                                        color: textColor, 
                                        font: { size: 14, weight: 'bold' },
                                        padding: 15
                                    },
                                    ticks: { 
                                        color: textColor, 
                                        backdropColor: 'transparent', 
                                        stepSize: 2, 
                                        beginAtZero: true, 
                                        max: 10,
                                        font: { size: 11 }
                                    },
                                    suggestedMin: 0,
                                    suggestedMax: 10
                                }
                            },
                            plugins: {
                                legend: { 
                                    display: true,
                                    labels: { 
                                        color: textColor,
                                        font: { size: 12 }
                                    } 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    padding: 12,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.r + '/10';
                                        },
                                        afterLabel: function(context) {
                                            const index = context.dataIndex;
                                            const detail = details[index];
                                            // Truncate long details for tooltip
                                            return detail.length > 100 ? detail.substring(0, 100) + '...' : detail;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Bar Chart
                    const ctxBar = document.getElementById('riskBarChart').getContext('2d');
                    new Chart(ctxBar, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Category Risk Score',
                                data: scores,
                                backgroundColor: backgroundColors,
                                borderColor: borderColors,
                                borderWidth: 2,
                                borderRadius: 8,
                                borderSkipped: false,
                            },
                            {
                                label: 'Overall Risk Score',
                                data: Array(labels.length).fill(overallScore),
                                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                                borderColor: 'rgba(52, 152, 219, 1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                type: 'line',
                                pointRadius: 0,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 10,
                                    ticks: { 
                                        color: textColor,
                                        stepSize: 2,
                                        font: { size: 11 }
                                    },
                                    grid: { color: gridColor },
                                    title: {
                                        display: true,
                                        text: 'Risk Level (0-10)',
                                        color: textColor,
                                        font: { size: 12, weight: 'bold' }
                                    }
                                },
                                x: {
                                    ticks: { 
                                        color: textColor,
                                        font: { size: 10 },
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: { display: false }
                                }
                            },
                            plugins: {
                                legend: { 
                                    display: true,
                                    labels: { 
                                        color: textColor,
                                        font: { size: 12 },
                                        usePointStyle: true,
                                        padding: 15
                                    } 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    padding: 12,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            if (context.dataset.label === 'Overall Risk Score') {
                                                return 'Overall Risk: ' + context.parsed.y.toFixed(1) + '/10';
                                            }
                                            return context.dataset.label + ': ' + context.parsed.y + '/10';
                                        },
                                        afterLabel: function(context) {
                                            if (context.dataset.label === 'Category Risk Score') {
                                                const index = context.dataIndex;
                                                const detail = details[index];
                                                return detail.length > 150 ? detail.substring(0, 150) + '...' : detail;
                                            }
                                            return '';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Pie Chart - Risk Proportion
                    const ctxPie = document.getElementById('riskPieChart').getContext('2d');
                    
                    // Create shorter labels for pie chart
                    const shortLabels = labels.map(label => {
                        if (label.includes('Water')) return 'Water';
                        if (label.includes('Air')) return 'Air Quality';
                        if (label.includes('Land')) return 'Land & Bio';
                        return label;
                    });
                    
                    new Chart(ctxPie, {
                        type: 'pie',
                        data: {
                            labels: shortLabels,
                            datasets: [{
                                label: 'Risk Score',
                                data: scores,
                                backgroundColor: backgroundColors,
                                borderColor: borderColors,
                                borderWidth: 2,
                                hoverOffset: 15
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: 10
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'right',
                                    labels: {
                                        color: textColor,
                                        font: { size: 13, weight: '600' },
                                        padding: 12,
                                        usePointStyle: true,
                                        boxWidth: 15,
                                        boxHeight: 15,
                                        generateLabels: function(chart) {
                                            const data = chart.data;
                                            if (data.labels.length && data.datasets.length) {
                                                return data.labels.map((label, i) => {
                                                    const value = data.datasets[0].data[i];
                                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                                    const percentage = ((value / total) * 100).toFixed(0);
                                                    return {
                                                        text: `${label}: ${percentage}%`,
                                                        fillStyle: data.datasets[0].backgroundColor[i],
                                                        hidden: false,
                                                        index: i
                                                    };
                                                });
                                            }
                                            return [];
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    padding: 12,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${label}: ${value}/10 (${percentage}%)`;
                                        },
                                        afterLabel: function(context) {
                                            const index = context.dataIndex;
                                            const detail = details[index];
                                            return detail.length > 100 ? detail.substring(0, 100) + '...' : detail;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Doughnut Chart - Risk Comparison with Overall Score
                    const ctxDoughnut = document.getElementById('riskDoughnutChart').getContext('2d');
                    
                    // Calculate average of category scores
                    const avgCategoryScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
                    const maxPossibleScore = 10;
                    
                    new Chart(ctxDoughnut, {
                        type: 'doughnut',
                        data: {
                            labels: ['Overall Risk', 'Remaining Safe Level'],
                            datasets: [{
                                label: 'Overall Assessment',
                                data: [overallScore, maxPossibleScore - overallScore],
                                backgroundColor: [
                                    overallScore < 4 ? 'rgba(39, 174, 96, 0.8)' : 
                                    overallScore < 7 ? 'rgba(243, 156, 18, 0.8)' : 
                                    'rgba(192, 57, 43, 0.8)',
                                    'rgba(149, 165, 166, 0.2)'
                                ],
                                borderColor: [
                                    overallScore < 4 ? 'rgba(39, 174, 96, 1)' : 
                                    overallScore < 7 ? 'rgba(243, 156, 18, 1)' : 
                                    'rgba(192, 57, 43, 1)',
                                    'rgba(149, 165, 166, 0.5)'
                                ],
                                borderWidth: 2,
                                hoverOffset: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '60%',
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        color: textColor,
                                        font: { size: 11 },
                                        padding: 15,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    padding: 12,
                                    displayColors: true,
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed;
                                            const percentage = ((value / maxPossibleScore) * 100).toFixed(1);
                                            return `${label}: ${value.toFixed(1)}/10 (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        },
                        plugins: [{
                            id: 'centerText',
                            beforeDraw: function(chart) {
                                const width = chart.width;
                                const height = chart.height;
                                const ctx = chart.ctx;
                                ctx.restore();
                                const fontSize = (height / 180).toFixed(2);
                                ctx.font = fontSize + "em sans-serif";
                                ctx.textBaseline = "middle";
                                ctx.fillStyle = textColor;
                                
                                const text = overallScore.toFixed(1);
                                const textX = Math.round((width - ctx.measureText(text).width) / 2);
                                const textY = height / 2 - 10;
                                
                                ctx.fillText(text, textX, textY);
                                
                                ctx.font = (fontSize * 0.5) + "em sans-serif";
                                const subtext = "/10";
                                const subtextX = Math.round((width - ctx.measureText(subtext).width) / 2);
                                const subtextY = height / 2 + 15;
                                ctx.fillText(subtext, subtextX, subtextY);
                                
                                ctx.save();
                            }
                        }]
                    });
                })();
                
                // Interactive Map Initialization
                (function() {
                    // Wait for Leaflet to be fully loaded
                    if (typeof L === 'undefined') {
                        console.error('Leaflet is not loaded');
                        return;
                    }
                    
                    // Get form data to extract location
                    const formData = {{ form_data | tojson | safe if form_data else '{}' }};
                    const overallScore = resultData.overall_risk_score;
                    const locationSearch = formData.location_search || '';
                    
                    // Determine pin color based on risk score
                    let pinColor = '#27ae60'; // Green (Low risk)
                    if (overallScore >= 7) {
                        pinColor = '#c0392b'; // Red (High risk)
                    } else if (overallScore >= 4) {
                        pinColor = '#f39c12'; // Orange (Moderate risk)
                    }
                    
                    // Extract coordinates from location search
                    let lat = 0, lon = 0;
                    let locationName = locationSearch;
                    
                    // Try multiple coordinate formats:
                    // 1. Simple: "40.5236, -112.1520"
                    // 2. With degrees: "51.1655¬∞ N, 71.4272¬∞ E"
                    // 3. With degrees without symbols: "51.1655 N, 71.4272 E"
                    // 4. Space separated: "40.5236 -112.1520"
                    
                    let coordMatch = null;
                    
                    // Pattern 1: degrees with symbols like "51.1655¬∞ N, 71.4272¬∞ E"
                    coordMatch = locationSearch.match(/(-?\d+\.?\d*)\s*¬∞?\s*([NS])?\s*,?\s*(-?\d+\.?\d*)\s*¬∞?\s*([EW])?/i);
                    if (coordMatch) {
                        lat = parseFloat(coordMatch[1]);
                        lon = parseFloat(coordMatch[3]);
                        
                        // Handle N/S/E/W directions
                        if (coordMatch[2] && coordMatch[2].toUpperCase() === 'S') lat = -lat;
                        if (coordMatch[4] && coordMatch[4].toUpperCase() === 'W') lon = -lon;
                        
                        locationName = `${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞`;
                        console.log('Parsed coordinates:', lat, lon);
                        initializeMap(lat, lon, locationName, pinColor, overallScore);
                    } else {
                        // Use Nominatim geocoding API to convert location name to coordinates
                        console.log('Geocoding location:', locationSearch);
                        
                        // Nominatim requires a User-Agent header, use fetch with headers
                        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationSearch)}&limit=1`, {
                            headers: {
                                'User-Agent': 'EcoImpactAI/1.0'
                            }
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Geocoding response:', data);
                                if (data && data.length > 0) {
                                    lat = parseFloat(data[0].lat);
                                    lon = parseFloat(data[0].lon);
                                    locationName = data[0].display_name;
                                    console.log('Geocoded successfully to:', lat, lon);
                                } else {
                                    // If geocoding fails, show alert and use world center
                                    console.warn('Geocoding returned no results for:', locationSearch);
                                    lat = 20;  // More visible default than 0,0
                                    lon = 0;
                                    locationName = `${locationSearch}`;
                                    alert(`Location "${locationSearch}" could not be found. Please try:\n‚Ä¢ Using coordinates (e.g., "40.5236, -112.1520")\n‚Ä¢ A more specific location name (e.g., "Bingham Canyon Mine, Utah")\n\nShowing approximate world location instead.`);
                                }
                                initializeMap(lat, lon, locationName, pinColor, overallScore);
                            })
                            .catch(error => {
                                console.error('Geocoding error:', error);
                                lat = 20;
                                lon = 0;
                                locationName = `${locationSearch}`;
                                alert(`Geocoding service error. Please try entering coordinates instead (e.g., "40.5236, -112.1520")`);
                                initializeMap(lat, lon, locationName, pinColor, overallScore);
                            });
                        return; // Exit here since geocoding is async
                    }
                    
                    // Function to initialize the map
                    function initializeMap(lat, lon, locationName, pinColor, overallScore) {
                        // Check if map container exists
                        const mapContainer = document.getElementById('siteMap');
                        if (!mapContainer) {
                            console.error('Map container not found');
                            return;
                        }
                        
                        // Clear any existing map
                        mapContainer.innerHTML = '';
                        
                        // Initialize the map
                        const map = L.map('siteMap').setView([lat, lon], 10);
                    
                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(map);
                    
                    // Create custom icon with dynamic color
                    const customIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                            background: ${pinColor};
                            width: 30px;
                            height: 30px;
                            border-radius: 50% 50% 50% 0;
                            transform: rotate(-45deg);
                            border: 3px solid white;
                            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                        "></div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    });
                    
                    // Add marker to the map
                    const marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
                    
                        // Create popup content
                        const riskLevel = overallScore < 4 ? 'Low Risk' : overallScore < 7 ? 'Moderate Risk' : 'High Risk';
                        const popupContent = `
                            <div style="font-family: 'DM Sans', sans-serif; min-width: 200px;">
                                <h4 style="margin: 0 0 0.5rem 0; color: ${pinColor}; font-size: 1.1rem;">Mining Site</h4>
                                <p style="margin: 0.3rem 0; font-size: 0.9rem;"><strong>Overall Risk:</strong> ${overallScore}/10</p>
                                <p style="margin: 0.3rem 0; font-size: 0.9rem;"><strong>Status:</strong> <span style="color: ${pinColor}; font-weight: bold;">${riskLevel}</span></p>
                                <p style="margin: 0.3rem 0; font-size: 0.85rem; color: #666;"><strong>Location:</strong> ${locationName}</p>
                                <p style="margin: 0.3rem 0; font-size: 0.85rem; color: #666;"><strong>Coordinates:</strong> ${lat.toFixed(4)}, ${lon.toFixed(4)}</p>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent).openPopup();
                        
                        // Add circle to show approximate impact area (radius based on risk)
                        const impactRadius = (overallScore / 10) * 5000; // Max 5km radius
                        L.circle([lat, lon], {
                            color: pinColor,
                            fillColor: pinColor,
                            fillOpacity: 0.1,
                            radius: impactRadius
                        }).addTo(map).bindTooltip(`Impact radius: ~${(impactRadius/1000).toFixed(1)}km`);
                    }
                })();
            </script>
            {% elif result_raw %}
             <div class="result">
                <h3 id="results-header">Analysis Results (Raw):</h3>
                <pre>{{ result_raw }}</pre>
            </div>
            <script> localStorage.clear(); </script>
            {% endif %}
        </div>
    </div>

    <div class="dock">
        <a href="/" class="dock-icon"><img src="{{ url_for('static', filename='logo.png') }}" alt="EcoImpact AI Logo"></a>
        <div class="dock-separator"></div>
        <a href="#" class="dock-icon lang-icon" onclick="changeLanguage('en')" aria-label="Switch to English">üá¨üáß</a>
        <a href="#" class="dock-icon lang-icon" onclick="changeLanguage('ru')" aria-label="Switch to Russian">üá∑üá∫</a>
        <a href="#" class="dock-icon lang-icon" onclick="changeLanguage('kz')" aria-label="Switch to Kazakh">üá∞üáø</a>
        <a href="#" class="dock-icon lang-icon" onclick="changeLanguage('uz')" aria-label="Switch to Uzbek">üá∫üáø</a>
    </div>

    <svg style="position: absolute; width: 0; height: 0; z-index: -1;">
      <filter id="frosted-glass">
        <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
        <feTurbulence type="fractalNoise" baseFrequency="0.05 0.01" numOctaves="2" result="turbulence"/>
        <feDisplacementMap in="blur" in2="turbulence" scale="30" />
      </filter>
    </svg>

    <script>
        const translations = {
             'en': { 'page-title': 'EcoImpact AI - Assessment', 'main-header': 'EcoImpact AI - Environmental Impact Assessment', 'location-header': 'Location Search', 'label-location-search': 'Location Name or Coordinates:', 'input-location-search': 'e.g., Bingham Canyon Mine or 40.523, -112.151', 'button-location-search': 'Search on Google Earth', 'mining-details-header': 'Mining Operation Details', 'label-annual-production': 'Annual Production Volume (tons/year):', 'label-mining-depth': 'Mining Depth (meters):', 'label-operation-years': 'Operation Years:', 'label-mine-type': 'Type of Mine:', 'option-select': 'Select...', 'option-open-pit': 'Open-pit', 'option-underground': 'Underground', 'option-mixed': 'Mixed', 'label-mineral-type': 'Primary Mineral Type:', 'option-select-mineral': 'Select...', 'option-coal': 'Coal', 'option-copper': 'Copper', 'option-gold': 'Gold', 'option-uranium': 'Uranium', 'option-iron': 'Iron', 'option-zinc-lead': 'Zinc-Lead', 'option-polymetallic': 'Polymetallic', 'geo-params-header': 'Geographic Parameters', 'label-distance-water': 'Distance to Nearest Water Body (km):', 'label-elevation': 'Elevation (meters above sea level):', 'label-precipitation': 'Annual Precipitation (mm/year):', 'label-soil-type': 'Soil Type:', 'option-select-soil': 'Select...', 'option-sandy': 'Sandy', 'option-clay': 'Clay', 'option-loam': 'Loam', 'option-rocky': 'Rocky', 'option-mountain': 'Mountain', 'option-desert': 'Desert', 'env-baseline-header': 'Environmental Baseline', 'label-water-quality': 'Baseline Water Quality (1-10):', 'label-air-quality': 'Baseline Air Quality (1-10):', 'label-vegetation-ndvi': 'Baseline Vegetation NDVI (0-1):', 'button-submit': 'Submit for Analysis', 'button-logs': 'View Logs', 'error-header': 'Error:', 'results-header': 'Analysis Results:', 'prevBtn': 'Previous', 'nextBtn': 'Next', 'button-pdf': 'Download PDF Report' },
             'ru': { 'page-title': 'EcoImpact AI - –û—Ü–µ–Ω–∫–∞', 'main-header': 'EcoImpact AI - –û—Ü–µ–Ω–∫–∞ –í–æ–∑–¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ –û–∫—Ä—É–∂–∞—é—â—É—é –°—Ä–µ–¥—É', 'location-header': '–ü–æ–∏—Å–∫ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è', 'label-location-search': '–ù–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è:', 'input-location-search': '–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä—É–¥–Ω–∏–∫ –ë–∏–Ω–≥–µ–º-–ö–∞–Ω—å–æ–Ω –∏–ª–∏ 40.523, -112.151', 'button-location-search': '–ò—Å–∫–∞—Ç—å –≤ Google Earth', 'mining-details-header': '–î–µ—Ç–∞–ª–∏ –ì–æ—Ä–Ω–æ–¥–æ–±—ã–≤–∞—é—â–µ–π –û–ø–µ—Ä–∞—Ü–∏–∏', 'label-annual-production': '–ì–æ–¥–æ–≤–æ–π –æ–±—ä–µ–º –¥–æ–±—ã—á–∏ (—Ç–æ–Ω–Ω/–≥–æ–¥):', 'label-mining-depth': '–ì–ª—É–±–∏–Ω–∞ –¥–æ–±—ã—á–∏ (–º–µ—Ç—Ä—ã):', 'label-operation-years': '–ì–æ–¥—ã —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏:', 'label-mine-type': '–¢–∏–ø —Ä—É–¥–Ω–∏–∫–∞:', 'option-select': '–í—ã–±–µ—Ä–∏—Ç–µ...', 'option-open-pit': '–û—Ç–∫—Ä—ã—Ç—ã–π', 'option-underground': '–ü–æ–¥–∑–µ–º–Ω—ã–π', 'option-mixed': '–°–º–µ—à–∞–Ω–Ω—ã–π', 'label-mineral-type': '–û—Å–Ω–æ–≤–Ω–æ–π —Ç–∏–ø –º–∏–Ω–µ—Ä–∞–ª–∞:', 'option-select-mineral': '–í—ã–±–µ—Ä–∏—Ç–µ...', 'option-coal': '–£–≥–æ–ª—å', 'option-copper': '–ú–µ–¥—å', 'option-gold': '–ó–æ–ª–æ—Ç–æ', 'option-uranium': '–£—Ä–∞–Ω', 'option-iron': '–ñ–µ–ª–µ–∑–æ', 'option-zinc-lead': '–¶–∏–Ω–∫-—Å–≤–∏–Ω–µ—Ü', 'option-polymetallic': '–ü–æ–ª–∏–º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π', 'geo-params-header': '–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã', 'label-distance-water': '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤–æ–¥–æ–µ–º–∞ (–∫–º):', 'label-elevation': '–í—ã—Å–æ—Ç–∞ (–º–µ—Ç—Ä—ã –Ω–∞–¥ —É—Ä–æ–≤–Ω–µ–º –º–æ—Ä—è):', 'label-precipitation': '–ì–æ–¥–æ–≤—ã–µ –æ—Å–∞–¥–∫–∏ (–º–º/–≥–æ–¥):', 'label-soil-type': '–¢–∏–ø –ø–æ—á–≤—ã:', 'option-select-soil': '–í—ã–±–µ—Ä–∏—Ç–µ...', 'option-sandy': '–ü–µ—Å—á–∞–Ω–∞—è', 'option-clay': '–ì–ª–∏–Ω–∏—Å—Ç–∞—è', 'option-loam': '–°—É–≥–ª–∏–Ω–æ–∫', 'option-rocky': '–°–∫–∞–ª–∏—Å—Ç–∞—è', 'option-mountain': '–ì–æ—Ä–Ω–∞—è', 'option-desert': '–ü—É—Å—Ç—ã–Ω–Ω–∞—è', 'env-baseline-header': '–ò—Å—Ö–æ–¥–Ω—ã–µ –≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –î–∞–Ω–Ω—ã–µ', 'label-water-quality': '–ò—Å—Ö–æ–¥–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤–æ–¥—ã (1-10):', 'label-air-quality': '–ò—Å—Ö–æ–¥–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ (1-10):', 'label-vegetation-ndvi': '–ò—Å—Ö–æ–¥–Ω—ã–π NDVI —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (0-1):', 'button-submit': '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏–∑', 'button-logs': '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏', 'error-header': '–û—à–∏–±–∫–∞:', 'results-header': '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:', 'prevBtn': '–ù–∞–∑–∞–¥', 'nextBtn': '–î–∞–ª–µ–µ', 'button-pdf': '–°–∫–∞—á–∞—Ç—å PDF –û—Ç—á–µ—Ç' },
             'kz': { 'page-title': 'EcoImpact AI - –ë–∞“ì–∞–ª–∞—É', 'main-header': 'EcoImpact AI - “ö–æ—Ä—à–∞“ì–∞–Ω –æ—Ä—Ç–∞“ì–∞ ”ô—Å–µ—Ä–¥—ñ –±–∞“ì–∞–ª–∞—É', 'location-header': '–û—Ä–Ω–∞–ª–∞—Å“õ–∞–Ω –∂–µ—Ä–¥—ñ —ñ–∑–¥–µ—É', 'label-location-search': '–û—Ä—ã–Ω–Ω—ã“£ –∞—Ç–∞—É—ã –Ω–µ–º–µ—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—Ç–∞—Ä—ã:', 'input-location-search': '–º—ã—Å–∞–ª—ã, –ë–∏–Ω–≥–µ–º –∫–∞–Ω—å–æ–Ω—ã –∫–µ–Ω—ñ—à—ñ –Ω–µ–º–µ—Å–µ 40.523, -112.151', 'button-location-search': 'Google Earth-—Ç–µ–Ω —ñ–∑–¥–µ—É', 'mining-details-header': '–¢–∞—É-–∫–µ–Ω ”©–Ω–¥—ñ—Ä—É –æ–ø–µ—Ä–∞—Ü–∏—è—Å—ã–Ω—ã“£ –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ', 'label-annual-production': '–ñ—ã–ª–¥—ã“õ ”©–Ω–¥—ñ—Ä—ñ—Å –∫”©–ª–µ–º—ñ (—Ç–æ–Ω–Ω–∞/–∂—ã–ª):', 'label-mining-depth': '–ö–µ–Ω –æ—Ä–Ω—ã–Ω—ã“£ —Ç–µ—Ä–µ“£–¥—ñ–≥—ñ (–º–µ—Ç—Ä):', 'label-operation-years': '–ü–∞–π–¥–∞–ª–∞–Ω—É –∂—ã–ª–¥–∞—Ä—ã:', 'label-mine-type': '–ö–µ–Ω—ñ—à —Ç“Ø—Ä—ñ:', 'option-select': '–¢–∞“£–¥–∞“£—ã–∑...', 'option-open-pit': '–ê—à—ã“õ', 'option-underground': '–ñ–µ—Ä–∞—Å—Ç—ã', 'option-mixed': '–ê—Ä–∞–ª–∞—Å', 'label-mineral-type': '–ù–µ–≥—ñ–∑–≥—ñ –º–∏–Ω–µ—Ä–∞–ª —Ç“Ø—Ä—ñ:', 'option-select-mineral': '–¢–∞“£–¥–∞“£—ã–∑...', 'option-coal': '–ö”©–º—ñ—Ä', 'option-copper': '–ú—ã—Å', 'option-gold': '–ê–ª—Ç—ã–Ω', 'option-uranium': '–£—Ä–∞–Ω', 'option-iron': '–¢–µ–º—ñ—Ä', 'option-zinc-lead': '–ú—ã—Ä—ã—à-“õ–æ—Ä“ì–∞—Å—ã–Ω', 'option-polymetallic': '–ü–æ–ª–∏–º–µ—Ç–∞–ª–ª', 'geo-params-header': '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è–ª—ã“õ –ø–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä', 'label-distance-water': '–ñ–∞“õ—ã–Ω —Å—É “õ–æ–π–º–∞—Å—ã–Ω–∞ –¥–µ–π—ñ–Ω–≥—ñ “õ–∞—à—ã“õ—Ç—ã“õ (–∫–º):', 'label-elevation': '–ë–∏—ñ–∫—Ç—ñ–∫ (—Ç–µ“£—ñ–∑ –¥–µ“£–≥–µ–π—ñ–Ω–µ–Ω –º–µ—Ç—Ä):', 'label-precipitation': '–ñ—ã–ª–¥—ã“õ –∂–∞—É—ã–Ω-—à–∞—à—ã–Ω (–º–º/–∂—ã–ª):', 'label-soil-type': '–¢–æ–ø—ã—Ä–∞“õ —Ç“Ø—Ä—ñ:', 'option-select-soil': '–¢–∞“£–¥–∞“£—ã–∑...', 'option-sandy': '“ö“±–º–¥—ã', 'option-clay': '–°–∞–∑–¥—ã', 'option-loam': '“ö“±–º–¥—ã —Å–∞–∑', 'option-rocky': '–¢–∞—Å—Ç—ã', 'option-mountain': '–¢–∞—É–ª—ã', 'option-desert': '–®”©–ª–¥—ñ', 'env-baseline-header': '–ë–∞—Å—Ç–∞–ø“õ—ã —ç–∫–æ–ª–æ–≥–∏–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä', 'label-water-quality': '–°—É–¥—ã“£ –±–∞—Å—Ç–∞–ø“õ—ã —Å–∞–ø–∞—Å—ã (1-10):', 'label-air-quality': '–ê—É–∞–Ω—ã“£ –±–∞—Å—Ç–∞–ø“õ—ã —Å–∞–ø–∞—Å—ã (1-10):', 'label-vegetation-ndvi': '”®—Å—ñ–º–¥—ñ–∫—Ç–µ—Ä–¥—ñ“£ –±–∞—Å—Ç–∞–ø“õ—ã NDVI (0-1):', 'button-submit': '–¢–∞–ª–¥–∞—É“ì–∞ –∂—ñ–±–µ—Ä—É', 'button-logs': '–ñ—É—Ä–Ω–∞–ª–¥–∞—Ä–¥—ã –∫”©—Ä—É', 'error-header': '“ö–∞—Ç–µ:', 'results-header': '–¢–∞–ª–¥–∞—É –Ω”ô—Ç–∏–∂–µ–ª–µ—Ä—ñ:', 'prevBtn': '–ê—Ä—Ç“õ–∞', 'nextBtn': '–ö–µ–ª–µ—Å—ñ', 'button-pdf': 'PDF –µ—Å–µ–±—ñ–Ω –∂“Ø–∫—Ç–µ–ø –∞–ª—É' },
             'uz': { 'page-title': 'EcoImpact AI - Baholash', 'main-header': 'EcoImpact AI - Atrof-muhitga ta\'sirni baholash', 'location-header': 'Joylashuvni qidirish', 'label-location-search': 'Joy nomi yoki koordinatalari:', 'input-location-search': 'masalan, Bingham Canyon koni yoki 40.523, -112.151', 'button-location-search': 'Google Earth\'da qidirish', 'mining-details-header': 'Kon-chilik ishlari tafsilotlari', 'label-annual-production': 'Yillik ishlab chiqarish hajmi (tonna/yil):', 'label-mining-depth': 'Qazib olish chuqurligi (metr):', 'label-operation-years': 'Foydalanish yillari:', 'label-mine-type': 'Kon turi:', 'option-select': 'Tanlang...', 'option-open-pit': 'Ochiq usulda', 'option-underground': 'Yer osti', 'option-mixed': 'Aralash', 'label-mineral-type': 'Asosiy mineral turi:', 'option-select-mineral': 'Tanlang...', 'option-coal': 'Ko\'mir', 'option-copper': 'Mis', 'option-gold': 'Oltin', 'option-uranium': 'Uran', 'option-iron': 'Temir', 'option-zinc-lead': 'Rux-qo\'rg\'oshin', 'option-polymetallic': 'Polimetall', 'geo-params-header': 'Geografik parametrlar', 'label-distance-water': 'Eng yaqin suv havzasigacha bo\'lgan masofa (km):', 'label-elevation': 'Balandlik (dengiz sathidan metr):', 'label-precipitation': 'Yillik yog\'ingarchilik (mm/yil):', 'label-soil-type': 'Tuproq turi:', 'option-select-soil': 'Tanlang...', 'option-sandy': 'Qumli', 'option-clay': 'Gilli', 'option-loam': 'Qumloq', 'option-rocky': 'Toshloq', 'option-mountain': 'Tog\'li', 'option-desert': 'Cho\'l', 'env-baseline-header': 'Boshlang\'ich ekologik ma\'lumotlar', 'label-water-quality': 'Suvning boshlang\'ich sifati (1-10):', 'label-air-quality': 'Havoning boshlang\'ich sifati (1-10):', 'label-vegetation-ndvi': 'O\'simliklarning boshlang\'ich NDVI (0-1):', 'button-submit': 'Tahlilga yuborish', 'button-logs': 'Jurnallarni ko\'rish', 'error-header': 'Xato:', 'results-header': 'Tahlil natijalari:', 'prevBtn': 'Orqaga', 'nextBtn': 'Keyingi', 'button-pdf': 'PDF Hisobotni Yuklab Olish' }
        };

        function changeLanguage(lang) {
            const langTranslations = translations[lang] || translations['en'];
            if (!langTranslations) return;
            localStorage.setItem('userLanguage', lang);
            Object.keys(langTranslations).forEach(id => {
                const element = document.getElementById(id);
                const translationText = langTranslations[id];
                if (element) {
                    if (element.tagName === 'INPUT') {
                        if (element.type === 'submit' || element.type === 'button') { element.value = translationText; } else { element.placeholder = translationText; }
                    } else if (element.tagName === 'BUTTON') { element.innerHTML = translationText; } else { element.textContent = translationText; }
                }
            });
            updateWizardButtons();
        }

        function searchOnGoogleEarth() {
            const query = document.getElementById('input-location-search-form').value;
            if (query) { const url = `https://earth.google.com/web/search/${encodeURIComponent(query)}`; window.open(url, '_blank'); } else { alert("Please enter a location or coordinates to search."); }
        }

        function setPrevious(option) { document.getElementById('theme-switcher').setAttribute('c-previous', option); }

        function setupFormListeners() {
            const form = document.getElementById('main-form');
            form.addEventListener('input', () => {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                localStorage.setItem('formState', JSON.stringify(data));
            });
        }

        function loadFormState() {
            const savedState = localStorage.getItem('formState');
            if (savedState) {
                const data = JSON.parse(savedState);
                for (const key in data) {
                    if (document.getElementsByName(key)[0]) { document.getElementsByName(key)[0].value = data[key]; }
                }
            }
        }

        let currentStep = 0; let formSteps;

        function showStep(stepIndex) {
            formSteps.forEach((step, index) => { step.style.display = (index === stepIndex) ? "block" : "none"; });
            updateWizardProgress(stepIndex);
            updateWizardButtons();
        }

        function navigateWizard(n) {
            if (n > 0 && !validateStep()) { return false; }
            formSteps[currentStep].style.display = "none";
            currentStep += n;
            if (currentStep >= formSteps.length) { document.getElementById("main-form").submit(); return false; }
            showStep(currentStep);
        }

        function validateStep() {
            let valid = true;
            const currentStepFields = formSteps[currentStep].querySelectorAll("input[required], select[required]");
            currentStepFields.forEach(field => {
                if (!field.value) { valid = false; field.classList.add("invalid"); } else { field.classList.remove("invalid"); }
            });
            return valid;
        }

        function updateWizardProgress(stepIndex) {
            const progressSteps = document.querySelectorAll(".wizard-progress-step");
            progressSteps.forEach((step, index) => {
                step.classList.remove("active", "finish");
                if (index < stepIndex) { step.classList.add("finish"); } else if (index === stepIndex) { step.classList.add("active"); }
            });
        }
        
        function updateWizardButtons() {
            const prevBtn = document.getElementById("prevBtn");
            const nextBtn = document.getElementById("nextBtn");
            const lang = localStorage.getItem('userLanguage') || 'en';
            const langTranslations = translations[lang] || translations['en'];
            prevBtn.style.display = currentStep === 0 ? "none" : "inline-block";
            if (currentStep === formSteps.length - 1) {
                nextBtn.innerHTML = langTranslations['button-submit'] || 'Submit for Analysis';
                nextBtn.type = 'submit';
            } else {
                nextBtn.innerHTML = langTranslations['nextBtn'] || 'Next';
                nextBtn.type = 'button';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const switcher = document.getElementById('theme-switcher');
            const checkedInput = switcher.querySelector('input:checked');
            setPrevious(checkedInput.getAttribute('c-option'));
            document.querySelectorAll('.switcher__input').forEach(input => {
                input.addEventListener('change', (e) => setPrevious(e.target.getAttribute('c-option')));
            });
            loadFormState();
            setupFormListeners();
            formSteps = document.querySelectorAll(".wizard-step");
            showStep(currentStep);
            const savedLang = localStorage.getItem('userLanguage') || 'en';
            changeLanguage(savedLang);
        });
    </script>
</body>
</html>